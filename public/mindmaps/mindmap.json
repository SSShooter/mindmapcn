{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "mindmap",
  "title": "MindMap",
  "description": "A MindElixir-powered map component with markers, popups, tooltips, routes, and controls.",
  "dependencies": [
    "mind-elixir",
    "next-themes",
    "lucide-react"
  ],
  "registryDependencies": [],
  "files": [
    {
      "path": "src/registry/mindmap.tsx",
      "content": "\"use client\";\r\n\r\nimport \"mind-elixir/style.css\";\r\nimport {\r\n  createContext,\r\n  useCallback,\r\n  useContext,\r\n  useEffect,\r\n  useId,\r\n  useRef,\r\n  useState,\r\n  type ReactNode,\r\n} from \"react\";\r\nimport { Minus, Plus, Download, Maximize2, Loader2 } from \"lucide-react\";\r\n\r\nimport { cn } from \"@/lib/utils\";\r\nimport type { MindElixirInstance, NodeObj, Options } from \"mind-elixir\";\r\n\r\n// Check document class for theme (works with next-themes, etc.)\r\nfunction getDocumentTheme(): Theme | null {\r\n  if (typeof document === \"undefined\") return null;\r\n  if (document.documentElement.classList.contains(\"dark\")) return \"dark\";\r\n  if (document.documentElement.classList.contains(\"light\")) return \"light\";\r\n  return null;\r\n}\r\n\r\n// Get system preference\r\nfunction getSystemTheme(): Theme {\r\n  if (typeof window === \"undefined\") return \"light\";\r\n  return window.matchMedia(\"(prefers-color-scheme: dark)\").matches\r\n    ? \"dark\"\r\n    : \"light\";\r\n}\r\n\r\nfunction useResolvedTheme(themeProp?: \"light\" | \"dark\"): \"light\" | \"dark\" {\r\n  const [detectedTheme, setDetectedTheme] = useState<\"light\" | \"dark\">(\r\n    () => getDocumentTheme() ?? getSystemTheme(),\r\n  );\r\n\r\n  useEffect(() => {\r\n    if (themeProp) return; // Skip detection if theme is provided via prop\r\n\r\n    // Watch for document class changes (e.g., next-themes toggling dark class)\r\n    const observer = new MutationObserver(() => {\r\n      const docTheme = getDocumentTheme();\r\n      if (docTheme) {\r\n        setDetectedTheme(docTheme);\r\n      }\r\n    });\r\n    observer.observe(document.documentElement, {\r\n      attributes: true,\r\n      attributeFilter: [\"class\"],\r\n    });\r\n\r\n    // Also watch for system preference changes\r\n    const mediaQuery = window.matchMedia(\"(prefers-color-scheme: dark)\");\r\n    const handleSystemChange = (e: MediaQueryListEvent) => {\r\n      // Only use system preference if no document class is set\r\n      if (!getDocumentTheme()) {\r\n        setDetectedTheme(e.matches ? \"dark\" : \"light\");\r\n      }\r\n    };\r\n    mediaQuery.addEventListener(\"change\", handleSystemChange);\r\n\r\n    return () => {\r\n      observer.disconnect();\r\n      mediaQuery.removeEventListener(\"change\", handleSystemChange);\r\n    };\r\n  }, [themeProp]);\r\n\r\n  return themeProp ?? detectedTheme;\r\n}\r\n\r\ntype Theme = \"light\" | \"dark\";\r\n\r\n// Context for MindMap\r\ninterface MindMapContextValue {\r\n  mind: MindElixirInstance | null;\r\n  isLoaded: boolean;\r\n}\r\n\r\nconst MindMapContext = createContext<MindMapContextValue | null>(null);\r\n\r\nexport function useMindMap() {\r\n  const context = useContext(MindMapContext);\r\n  if (!context) {\r\n    throw new Error(\"useMindMap must be used within a MindMap component\");\r\n  }\r\n  return context;\r\n}\r\n\r\n// MindMap Props\r\ninterface MindMapData {\r\n  nodeData: {\r\n    id: string;\r\n    topic: string;\r\n    root?: boolean;\r\n    children?: MindMapData[\"nodeData\"][];\r\n    [key: string]: unknown;\r\n  };\r\n}\r\n\r\ninterface MindMapProps {\r\n  children?: ReactNode;\r\n  data?: MindMapData;\r\n  className?: string;\r\n  direction?: 0 | 1 | 2;\r\n  draggable?: boolean;\r\n  contextMenu?: boolean;\r\n  toolBar?: boolean;\r\n  nodeMenu?: boolean;\r\n  keypress?: boolean;\r\n  locale?: \"en\" | \"zh_CN\" | \"zh_TW\" | \"ja\" | \"pt\";\r\n  overflowHidden?: boolean;\r\n  mainLinkStyle?: number;\r\n  theme?: \"dark\" | \"light\";\r\n  fit?: boolean;\r\n  onOperation?: (operation: unknown) => void;\r\n  onSelectNodes?: (nodeObj: NodeObj[]) => void;\r\n  loader?: ReactNode;\r\n}\r\n\r\nfunction DefaultLoader() {\r\n  return (\r\n    <div className=\"absolute inset-0 flex items-center justify-center bg-background/80 backdrop-blur-sm\">\r\n      <Loader2 className=\"size-8 animate-spin text-muted-foreground\" />\r\n    </div>\r\n  );\r\n}\r\n\r\nexport function MindMap({\r\n  children,\r\n  data,\r\n  className,\r\n  direction = 1, // MindElixir.SIDE\r\n  draggable = true,\r\n  contextMenu = true,\r\n  toolBar = false,\r\n  nodeMenu = true,\r\n  keypress = true,\r\n  locale = \"en\",\r\n  overflowHidden = false,\r\n  mainLinkStyle = 2,\r\n  theme: themeProp,\r\n  fit = true,\r\n  onOperation,\r\n  onSelectNodes,\r\n  loader,\r\n}: MindMapProps) {\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n  const mindRef = useRef<MindElixirInstance | null>(null);\r\n  const [isLoaded, setIsLoaded] = useState(false);\r\n  const [mindInstance, setMindInstance] = useState<MindElixirInstance | null>(\r\n    null,\r\n  );\r\n  const [isMounted, setIsMounted] = useState(false);\r\n  const resolvedTheme = useResolvedTheme(themeProp);\r\n  const id = useId();\r\n  \r\n  // Store resolvedTheme in a ref for use in effects without triggering re-runs\r\n  const resolvedThemeRef = useRef(resolvedTheme);\r\n  useEffect(() => {\r\n    resolvedThemeRef.current = resolvedTheme;\r\n  }, [resolvedTheme]);\r\n\r\n  // Ensure component only renders on client\r\n  useEffect(() => {\r\n    setIsMounted(true);\r\n  }, []);\r\n\r\n  // Initialize MindElixir (client-side only)\r\n  useEffect(() => {\r\n    if (!isMounted || !containerRef.current || mindRef.current) return;\r\n\r\n    let isSubscribed = true;\r\n\r\n    // Dynamic import to avoid SSR issues\r\n    import(\"mind-elixir\").then((MindElixirModule) => {\r\n      if (!isSubscribed || !containerRef.current) return;\r\n\r\n      const MindElixir = MindElixirModule.default;\r\n\r\n      const options = {\r\n        el: containerRef.current,\r\n        direction,\r\n        draggable,\r\n        contextMenu,\r\n        toolBar,\r\n        nodeMenu,\r\n        keypress,\r\n        locale,\r\n        overflowHidden,\r\n        mainLinkStyle,\r\n        alignment: \"nodes\",\r\n        theme:\r\n          resolvedThemeRef.current === \"dark\" ? MindElixir.DARK_THEME : MindElixir.THEME,\r\n      } as Options;\r\n\r\n      try {\r\n        const mind = new MindElixir(options);\r\n\r\n        // Initialize with data or create new\r\n        const initialData = data || MindElixir.new(\"Mind Map\");\r\n        mind.init(initialData);\r\n\r\n        if (isSubscribed) {\r\n          mindRef.current = mind;\r\n          setMindInstance(mind);\r\n          setIsLoaded(true);\r\n\r\n          // Auto-fit if enabled\r\n          if (fit) {\r\n            mind.scaleFit();\r\n          }\r\n\r\n          // Event listeners\r\n          if (onOperation) {\r\n            mind.bus.addListener(\"operation\", onOperation);\r\n          }\r\n          if (onSelectNodes) {\r\n            mind.bus.addListener(\"selectNodes\", onSelectNodes);\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Failed to initialize MindElixir:\", error);\r\n      }\r\n    });\r\n\r\n    return () => {\r\n      isSubscribed = false;\r\n      // Note: We intentionally don't clean up the mind instance here\r\n      // to avoid DOM manipulation conflicts with React\r\n      // The instance will be garbage collected when the component unmounts\r\n      mindRef.current = null;\r\n    };\r\n  }, [\r\n    isMounted,\r\n    direction,\r\n    draggable,\r\n    contextMenu,\r\n    toolBar,\r\n    nodeMenu,\r\n    keypress,\r\n    locale,\r\n    overflowHidden,\r\n    mainLinkStyle,\r\n    fit,\r\n    data,\r\n    onOperation,\r\n    onSelectNodes,\r\n  ]);\r\n\r\n  // Update data when it changes\r\n  useEffect(() => {\r\n    if (mindRef.current && data && isLoaded) {\r\n      mindRef.current.refresh(data);\r\n    }\r\n  }, [data, isLoaded]);\r\n\r\n  // Update theme when resolvedTheme changes\r\n  useEffect(() => {\r\n    if (!mindRef.current || !isLoaded) return;\r\n\r\n    import(\"mind-elixir\").then((MindElixirModule) => {\r\n      if (!mindRef.current) return;\r\n      debugger\r\n      const MindElixir = MindElixirModule.default;\r\n      const newTheme =\r\n        resolvedTheme === \"dark\" ? MindElixir.DARK_THEME : MindElixir.THEME;\r\n      mindRef.current.changeTheme(newTheme, false);\r\n    });\r\n  }, [resolvedTheme, isLoaded]);\r\n\r\n  return (\r\n    <MindMapContext.Provider value={{ mind: mindInstance, isLoaded }}>\r\n      <div\r\n        key={id}\r\n        ref={containerRef}\r\n        id={`mindmap-${id}`}\r\n        className={cn(\r\n          \"relative w-full h-full bg-background rounded-lg overflow-hidden\",\r\n          className,\r\n        )}\r\n      ></div>\r\n      {!isMounted || !isLoaded ? loader || <DefaultLoader /> : null}\r\n      {children}\r\n    </MindMapContext.Provider>\r\n  );\r\n}\r\n\r\n// MindMap Controls\r\ninterface MindMapControlsProps {\r\n  position?: \"top-left\" | \"top-right\" | \"bottom-left\" | \"bottom-right\";\r\n  showZoom?: boolean;\r\n  showFit?: boolean;\r\n  showExport?: boolean;\r\n  className?: string;\r\n  onExport?: (type: \"png\" | \"svg\" | \"json\") => void;\r\n}\r\n\r\nexport function MindMapControls({\r\n  position = \"top-right\",\r\n  showZoom = true,\r\n  showFit = true,\r\n  showExport = true,\r\n  className,\r\n  onExport,\r\n}: MindMapControlsProps) {\r\n  const { mind, isLoaded } = useMindMap();\r\n  const [mounted, setMounted] = useState(false);\r\n\r\n  useEffect(() => {\r\n    const timer = setTimeout(() => setMounted(true), 0);\r\n    return () => clearTimeout(timer);\r\n  }, []);\r\n\r\n  const handleZoomIn = useCallback(() => {\r\n    if (mind) {\r\n      const currentScale = mind.scaleVal || 1;\r\n      mind.scale(currentScale + 0.2);\r\n    }\r\n  }, [mind]);\r\n\r\n  const handleZoomOut = useCallback(() => {\r\n    if (mind) {\r\n      const currentScale = mind.scaleVal || 1;\r\n      mind.scale(Math.max(0.2, currentScale - 0.2));\r\n    }\r\n  }, [mind]);\r\n\r\n  const handleFit = useCallback(() => {\r\n    if (mind) {\r\n      mind.scaleFit();\r\n    }\r\n  }, [mind]);\r\n\r\n  const handleExport = useCallback(() => {\r\n    if (mind && onExport) {\r\n      // Export as JSON by default\r\n      const data = mind.getData();\r\n      onExport(\"json\");\r\n\r\n      // Download JSON\r\n      const blob = new Blob([JSON.stringify(data, null, 2)], {\r\n        type: \"application/json\",\r\n      });\r\n      const url = URL.createObjectURL(blob);\r\n      const a = document.createElement(\"a\");\r\n      a.href = url;\r\n      a.download = \"mindmap.json\";\r\n      a.click();\r\n      URL.revokeObjectURL(url);\r\n    }\r\n  }, [mind, onExport]);\r\n\r\n  if (!mounted || !isLoaded) return null;\r\n\r\n  const positionClasses = {\r\n    \"top-left\": \"top-3 left-3\",\r\n    \"top-right\": \"top-3 right-3\",\r\n    \"bottom-left\": \"bottom-3 left-3\",\r\n    \"bottom-right\": \"bottom-3 right-3\",\r\n  };\r\n\r\n  return (\r\n    <div\r\n      className={cn(\r\n        \"absolute z-10 flex flex-col gap-1\",\r\n        positionClasses[position],\r\n        className,\r\n      )}\r\n    >\r\n      {showZoom && (\r\n        <>\r\n          <button\r\n            onClick={handleZoomIn}\r\n            className=\"size-8 rounded-md bg-background/95 backdrop-blur-md border border-border/50 shadow-lg flex items-center justify-center hover:bg-accent transition-colors\"\r\n            aria-label=\"Zoom in\"\r\n          >\r\n            <Plus className=\"size-4\" />\r\n          </button>\r\n          <button\r\n            onClick={handleZoomOut}\r\n            className=\"size-8 rounded-md bg-background/95 backdrop-blur-md border border-border/50 shadow-lg flex items-center justify-center hover:bg-accent transition-colors\"\r\n            aria-label=\"Zoom out\"\r\n          >\r\n            <Minus className=\"size-4\" />\r\n          </button>\r\n        </>\r\n      )}\r\n      {showFit && (\r\n        <button\r\n          onClick={handleFit}\r\n          className=\"size-8 rounded-md bg-background/95 backdrop-blur-md border border-border/50 shadow-lg flex items-center justify-center hover:bg-accent transition-colors\"\r\n          aria-label=\"Fit to screen\"\r\n        >\r\n          <Maximize2 className=\"size-4\" />\r\n        </button>\r\n      )}\r\n      {showExport && (\r\n        <button\r\n          onClick={handleExport}\r\n          className=\"size-8 rounded-md bg-background/95 backdrop-blur-md border border-border/50 shadow-lg flex items-center justify-center hover:bg-accent transition-colors\"\r\n          aria-label=\"Export\"\r\n        >\r\n          <Download className=\"size-4\" />\r\n        </button>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n\r\n// Export components\r\n",
      "type": "registry:ui",
      "target": "components/ui/mindmap.tsx"
    }
  ],
  "css": {
    "@layer base": {
      ".mindelixir-popup-content": {
        "@apply bg-transparent! shadow-none! p-0! rounded-none!": {}
      },
      ".mindelixir-popup-tip": {
        "@apply hidden!": {}
      }
    }
  },
  "type": "registry:ui"
}